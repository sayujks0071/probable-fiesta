name: Daily Symbol Normalizer (Hard-Gate)

on:
  schedule:
    - cron: '30 02 * * *'  # 02:30 UTC (08:00 IST)
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  normalize-and-audit:
    runs-on: ubuntu-latest
    outputs:
      gate_ok: ${{ steps.gate.outputs.ok }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Set Date
        run: echo "DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          pip install -r openalgo/requirements.txt
          pip install pandas pyyaml

      - name: Sync Instruments
        id: sync
        run: python tools/sync_instruments.py

      - name: Pre-Normalization Strict Validation
        id: pre-check
        continue-on-error: true
        run: |
          python tools/validate_symbols.py --strict --check

      - name: Normalize Symbols (Write Mode)
        id: normalize
        if: steps.pre-check.outcome == 'success'
        run: |
           python tools/normalize_symbols_repo.py --write
           # Rename reports to preserve them from being overwritten by post-check
           mv reports/symbol_audit.json reports/normalization_audit.json
           mv reports/symbol_audit.md reports/normalization_audit.md

      - name: Post-Normalization Strict Validation
        id: post-check
        if: steps.normalize.outcome == 'success'
        run: python tools/validate_symbols.py --strict --check

      - name: Gate Check
        id: gate
        if: steps.post-check.outcome == 'success'
        run: echo "ok=true" >> $GITHUB_OUTPUT

      - name: Upload Audit Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: symbol-audit-reports
          path: |
            reports/symbol_audit.*
            reports/normalization_audit.*

      - name: Create Pull Request
        if: steps.gate.outputs.ok == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: daily symbol normalization"
          title: "chore: Daily Symbol Normalization (${{ env.DATE }})"
          body: |
            Daily symbol normalization report for ${{ env.DATE }}.

            Normalization Audit and Final Validation Report attached.
          branch: "chore/symbols-daily-${{ env.DATE }}"
          delete-branch: true
          base: main

      - name: Create Failure Issue
        if: failure() || (steps.gate.outputs.ok != 'true')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = "The daily symbol normalization workflow failed or did not pass the hard-gate.\n\n";
            try {
              if (fs.existsSync('reports/symbol_audit.md')) {
                const report = fs.readFileSync('reports/symbol_audit.md', 'utf8');
                body += report;
              }
            } catch (e) {
              body += "Failed to read audit report.";
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Symbol audit failed (daily) â€” ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['symbols']
            });
