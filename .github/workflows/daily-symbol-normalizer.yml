name: Daily Symbol Normalizer (Hard-Gate)

on:
  schedule:
    - cron: '30 2 * * *'  # 02:30 UTC
  workflow_dispatch:

jobs:
  normalize-and-audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install pandas requests

      - name: Sync Instruments
        run: python tools/sync_instruments.py

      - name: Strict Validator (Pre-Check)
        id: pre_check
        continue-on-error: true
        run: python tools/validate_symbols.py --strict --check

      - name: Normalize Symbols
        if: steps.pre_check.outcome == 'success'
        run: python tools/normalize_symbols_repo.py --write

      - name: Strict Validator (Post-Check)
        id: post_check
        if: steps.pre_check.outcome == 'success'
        continue-on-error: true
        run: python tools/validate_symbols.py --strict --check

      - name: Determine Gate Status
        id: gate
        run: |
          if [[ "${{ steps.pre_check.outcome }}" == "success" && "${{ steps.post_check.outcome }}" == "success" ]]; then
            echo "gate_ok=true" >> $GITHUB_OUTPUT
            echo "Gate OK: All checks passed."
          else
            echo "gate_ok=false" >> $GITHUB_OUTPUT
            echo "Gate FAILED: Validation errors found."
          fi

      - name: Upload Audit Reports
        uses: actions/upload-artifact@v3
        with:
          name: symbol-audit-reports
          path: reports/

      - name: Create Pull Request
        if: steps.gate.outputs.gate_ok == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: normalize symbols [strict mode]"
          title: "chore: daily symbol normalization"
          body: "Automated symbol normalization passed strict validation. See attached audit report."
          branch: "chore/symbols-daily-$(date +%Y-%m-%d)"
          delete-branch: true

      - name: Create Issue on Failure
        if: steps.gate.outputs.gate_ok == 'false'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "Symbol Audit Failed (Daily) â€” $(date +%Y-%m-%d)"
          content-filepath: reports/symbol_audit.md
          labels: symbols
