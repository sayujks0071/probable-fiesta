name: Daily Symbol Normalizer

on:
  schedule:
    - cron: '30 2 * * *' # 02:30 UTC
  workflow_dispatch:

jobs:
  normalize:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r openalgo/requirements.txt

      - name: Initialize Gate
        run: echo "gate_ok=true" >> $GITHUB_ENV

      - name: Get Date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Sync Instruments
        run: python tools/sync_instruments.py

      - name: Strict Validation (Pre-Check)
        id: pre_check
        continue-on-error: true
        run: |
          set +e
          python tools/validate_symbols.py --strict --check
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Pre-Check Gate
        if: steps.pre_check.outputs.exit_code != '0'
        run: |
          echo "❌ Pre-check failed. Stopping normalization."
          echo "gate_ok=false" >> $GITHUB_ENV

      - name: Normalize Symbols
        if: env.gate_ok != 'false'
        run: |
          python tools/normalize_symbols_repo.py --write

      - name: Strict Validation (Post-Check)
        if: env.gate_ok != 'false'
        id: post_check
        continue-on-error: true
        run: |
          set +e
          python tools/validate_symbols.py --strict --check
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Post-Check Gate
        if: env.gate_ok != 'false' && steps.post_check.outputs.exit_code != '0'
        run: |
          echo "❌ Post-check failed. Normalization introduced errors or failed to fix."
          echo "gate_ok=false" >> $GITHUB_ENV

      - name: Verify Git Changes
        if: env.gate_ok != 'false'
        id: git_status
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: env.gate_ok != 'false' && steps.git_status.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: chore/symbols-daily-${{ steps.date.outputs.today }}
          title: "chore: Normalize Symbols (Daily) - ${{ steps.date.outputs.today }}"
          body: |
             Daily symbol normalization run.

             See attached audit report for details.
          commit-message: "chore: normalize symbols [skip ci]"
          add-paths: |
            **/*.py
            **/*.json
            **/*.yaml
            reports/symbol_audit.json
            reports/symbol_audit.md

      - name: Upload Audit Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: symbol-audit-reports
          path: reports/symbol_audit.*

      - name: Create Issue on Failure
        if: env.gate_ok == 'false'
        uses: dacbd/create-issue-action@main
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Symbol audit failed (daily) — $(date +'%Y-%m-%d')"
          body: |
            ### Symbol Audit Failed

            The daily symbol normalization job failed strict validation.

            **Pre-Check Exit Code:** ${{ steps.pre_check.outputs.exit_code }}
            **Post-Check Exit Code:** ${{ steps.post_check.outputs.exit_code }}

            Please check the uploaded artifacts for details.
          labels: symbols
