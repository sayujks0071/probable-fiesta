name: Daily Symbol Normalizer

on:
  schedule:
    - cron: '30 02 * * *' # 02:30 UTC = 08:00 IST
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  audit-and-normalize:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install -r openalgo/requirements.txt
          pip install types-requests

      - name: Sync Instruments
        run: python tools/sync_instruments.py

      - name: Pre-Check (Strict Validator)
        id: pre_check
        run: python tools/validate_symbols.py --strict --check
        # Hard-Gate: If this fails, we stop and do NOT proceed to normalization/PR.
        # However, we must ensure artifacts are uploaded.
        continue-on-error: false

      - name: Normalize Symbols (Write)
        id: normalize
        # This only runs if pre_check succeeded (which means symbols are valid)
        # This implies normalization might be redundant unless validate allows non-normalized?
        # But Strict Validator fails on malformed. So this step is effectively reachable only if everything is already valid.
        if: success()
        run: python tools/normalize_symbols_repo.py --write

      - name: Post-Check (Strict Validator)
        id: post_check
        if: success()
        run: python tools/validate_symbols.py --strict --check

      - name: Determine Gate Status
        id: gate
        if: always()
        run: |
          if [ "${{ steps.post_check.outcome }}" == "success" ]; then
            echo "gate_ok=true" >> $GITHUB_OUTPUT
          else
            echo "gate_ok=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Audit Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: symbol-audit-reports
          path: reports/symbol_audit.*

      - name: Create Pull Request
        # Only if Gate OK (implying Post-Check passed, which implies Pre-Check passed)
        if: steps.gate.outputs.gate_ok == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(symbols): normalize trading symbols [strict]"
          branch: chore/symbols-daily
          delete-branch: true
          title: "chore: Daily Symbol Normalization & Audit"
          body: |
            ### Symbol Audit Report
            - Strict Mode: Enabled
            - Validation: Passed

            See attached audit report in workflow artifacts for details.
          labels: |
            maintenance
            symbols

      - name: Open Issue on Failure
        # If Gate Failed (Pre-Check or Post-Check failed)
        if: failure() || steps.gate.outputs.gate_ok == 'false'
        uses: dacbd/create-issue-action@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Symbol audit failed (daily) — ${{ github.event.schedule }}"
          body: |
            ### ❌ Symbol Audit Failed
            The daily symbol normalization and validation process failed.

            **Reason:** Strict validation failed.
            Note: Under Hard-Gate policy, automated PRs are blocked if invalid symbols exist.

            Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and the attached `symbol_audit` artifacts.

            **Action Required:**
            - Check `reports/symbol_audit.md`
            - Fix invalid symbols manually or run `tools/normalize_symbols_repo.py --write` locally.
          labels: symbols
