name: Daily Symbol Normalizer (Strict)

on:
  schedule:
    - cron: '30 02 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  normalize-and-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install pandas requests httpx python-dotenv

      - name: Sync Instruments
        run: python tools/sync_instruments.py

      - name: Pre-Check (Strict Validator)
        id: precheck
        continue-on-error: true
        run: |
          if python tools/validate_symbols.py --strict --check; then
            echo "gate_ok=true" >> $GITHUB_OUTPUT
          else
            echo "gate_ok=false" >> $GITHUB_OUTPUT
            echo "::error::Pre-check failed. Validation errors found."
          fi

      - name: Normalize Symbols (Write)
        if: steps.precheck.outputs.gate_ok == 'true'
        run: python tools/normalize_symbols_repo.py --write

      - name: Post-Check (Strict Validator)
        if: steps.precheck.outputs.gate_ok == 'true'
        id: postcheck
        continue-on-error: true
        run: |
          if python tools/validate_symbols.py --strict --check; then
            echo "gate_final=true" >> $GITHUB_OUTPUT
          else
            echo "gate_final=false" >> $GITHUB_OUTPUT
            echo "::error::Post-check failed. Normalization introduced errors or failed to fix all issues."
          fi

      - name: Upload Audit Reports
        uses: actions/upload-artifact@v3
        with:
          name: symbol-audit-reports
          path: reports/

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.postcheck.outputs.gate_final == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: normalize symbols and audit report"
          branch: chore/symbols-daily
          delete-branch: true
          title: "chore: Daily Symbol Normalization & Audit - ${{ steps.date.outputs.date }}"
          body: |
            Daily symbol normalization and audit report.

            Strict validation passed.

            See attached audit report for details.

            Date: ${{ steps.date.outputs.date }}
          base: main

      - name: Create Issue on Failure
        if: steps.precheck.outputs.gate_ok == 'false' || steps.postcheck.outputs.gate_final == 'false'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            let body = "### Symbol Audit Failed\n\nThe daily symbol normalization workflow failed strict validation.\n\n";
            try {
              if (fs.existsSync('reports/symbol_audit.md')) {
                const report = fs.readFileSync('reports/symbol_audit.md', 'utf8');
                body += report;
              }
            } catch (e) {
              body += "Could not read audit report.";
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Symbol Audit Failed (Daily) - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['symbols', 'audit-failed']
            });
