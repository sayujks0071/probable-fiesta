# Port 5002 Issues - Fixes Applied
**Date**: January 28, 2026  
**Fixed by**: Port 5002 Troubleshooter Subagents

---

## ‚úÖ Fixes Applied

### 1. 403 FORBIDDEN Errors (Critical) - FIXED ‚úÖ

**Problem**: Delta Neutral Iron Condor strategy getting 403 FORBIDDEN errors on `/api/v1/optionchain` endpoint.

**Root Cause**: Missing `OPENALGO_HOST` configuration for port 5002 strategies.

**Fix Applied**:
- Updated `strategy_env.json` to set `OPENALGO_HOST` to `http://127.0.0.1:5002` for:
  - `delta_neutral_iron_condor_nifty_20260123131614`
  - `delta_neutral_iron_condor_nifty`
- Verified API key is configured: `630db05e091812b4c23298ca2d018b62376ddd168860d21fcb4bd2dfc265e49f`

**Current Configuration**:
```json
{
  "delta_neutral_iron_condor_nifty_20260123131614": {
    "OPENALGO_APIKEY": "630db05e091812b4c23298ca2d018b62376ddd168860d21fcb4bd2dfc265e49f",
    "SYMBOL": "NIFTY",
    "OPENALGO_HOST": "http://127.0.0.1:5002"
  }
}
```

**Next Step**: Restart the strategy for changes to take effect.

---

### 2. CSRF Token and Login Rate Limit (Medium) - GUIDANCE PROVIDED ‚úÖ

**Problem**: Web UI showing CSRF errors and login rate limit exceeded.

**Guidance Provided**:
1. Clear browser cache and cookies for `http://127.0.0.1:5002`
2. Wait 1 minute for rate limit to clear (5 attempts per minute)
3. Log in to Web UI: `http://127.0.0.1:5002`
   - Username: `sayujks0071`
   - Password: `Apollo@20417`
4. Try starting strategies again

**Alternative**: Use API or scripts to start strategies (avoids Web UI session issues).

---

### 3. Database Logging Errors (Low Priority) - FIXED ‚úÖ

**Problem**: `sqlite3.ProgrammingError: Error binding parameter 14: type 'dict' is not supported`

**Root Cause**: Dict being passed to SQL parameter that expects string (related to INDIA VIX history requests with invalid interval).

**Fix Applied**:
- Updated `openalgo/database/latency_db.py`:
  - Added `json` import
  - Modified `log_latency()` to serialize dict errors to JSON string
  - Added error string length limit (500 chars) to match column definition

**Code Changes**:
```python
# Convert error to string if it's a dict (fixes SQL parameter binding error)
error_str = error
if isinstance(error, dict):
    error_str = json.dumps(error)
elif error is not None:
    error_str = str(error)

# Ensure error string doesn't exceed column length (500 chars)
if error_str and len(error_str) > 500:
    error_str = error_str[:497] + "..."
```

**Impact**: Non-critical fix (doesn't affect trading functionality, only latency logging).

---

## üìã Next Steps

### Immediate Actions Required:

1. **Restart Delta Neutral Iron Condor Strategy**:
   ```bash
   # Option 1: Via Web UI
   # Go to: http://127.0.0.1:5002/python
   # Find: delta_neutral_iron_condor_nifty
   # Click: Stop ‚Üí Start
   
   # Option 2: Via API (if Web UI has session issues)
   # Get strategy ID first, then restart via API
   ```

2. **Monitor Strategy Logs**:
   ```bash
   tail -f openalgo/log/strategies/delta_neutral_iron_condor_nifty_*.log | grep -E "403|200|success|optionchain|API Error"
   ```

3. **Verify API Access**:
   ```bash
   # Test option chain API
   curl -X POST http://127.0.0.1:5002/api/v1/optionchain \
     -H "Content-Type: application/json" \
     -H "X-API-Key: 630db05e091812b4c23298ca2d018b62376ddd168860d21fcb4bd2dfc265e49f" \
     -d '{"underlying": "NIFTY", "exchange": "NSE_INDEX"}'
   ```

### Expected Results After Restart:

- ‚úÖ No more 403 FORBIDDEN errors
- ‚úÖ Successful API calls (200 responses)
- ‚úÖ No "Using mock chain" warnings
- ‚úÖ Real option chain data being fetched
- ‚úÖ Database logging errors resolved

---

## üîç Verification Commands

```bash
# Check strategy configuration
cd openalgo/strategies
cat strategy_env.json | jq '.["delta_neutral_iron_condor_nifty_20260123131614"]'

# Monitor server logs for successful requests
tail -f openalgo/log/dhan_openalgo.log | grep -E "optionchain|200|403"

# Check for 403 errors in strategy logs
grep -c "403\|FORBIDDEN" openalgo/log/strategies/delta_neutral_iron_condor_nifty_*.log
```

---

## üìù Files Modified

1. **`openalgo/strategies/strategy_env.json`**
   - Added `OPENALGO_HOST` for port 5002 strategies

2. **`openalgo/database/latency_db.py`**
   - Fixed dict serialization in `log_latency()` function

3. **`openalgo/scripts/fix_port5002_issues.py`** (NEW)
   - Comprehensive fix script for Port 5002 issues

---

## üéØ Summary

- ‚úÖ **403 FORBIDDEN**: Fixed by configuring `OPENALGO_HOST` for port 5002
- ‚úÖ **CSRF/Login Rate Limit**: Guidance provided (use API/scripts as workaround)
- ‚úÖ **Database Logging**: Fixed dict serialization issue

**Status**: All fixes applied. Restart strategies to verify.

---

**Report generated by**: Port 5002 Troubleshooter Subagents  
**Fix script**: `openalgo/scripts/fix_port5002_issues.py`
